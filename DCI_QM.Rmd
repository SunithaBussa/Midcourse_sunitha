---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 
```{r}
options(scipen = 999)
```

```{r}
library(tidyverse)
library(ggplot2)
library(plotly)
```

```{r}
summary_raw_data<-read_csv ('data/claim_summary_v1.csv' )
summary_wds<-summary_raw_data
```

 
```{r}
#claim_summary_raw<-read_csv('data/claim_summary.csv')
#811454

summary_wds %>% 
  select (-esco_id,-bene_hic_num,-esco_aligned_flag) %>% 
  filter(patient_id == '811454') %>% 
  arrange(dos_year,dos_month)

```

```{r}
str(summary_wds)
```
```{r}
summary(summary_wds)
```

```{r}
summary_wds %>% 
  ggplot(aes(x=payment)) +
  geom_histogram(breaks = seq(500,100000,by=1000),
                 bins=10,
                 col="red",
                 fill = "green",
                 alpha = 0.2) +
 scale_x_log10()  +
  labs(x="Payments", y = "Counts",title = "Payments Histogram")  
```
 
 
```{r}
change_increase<-summary_wds %>% 
  select (patient_id,payment,dos_year,dos_month) %>% 
  group_by(patient_id,dos_year) %>% 
  summarise(sum_payment = sum(payment), num_of_months = NROW(dos_month)) %>% 
  ungroup %>% 
  filter(num_of_months >11) %>% 
  arrange (num_of_months,patient_id,dos_year,desc(sum_payment)) 


change_increase

```


```{r}
#pivot the data and understand hte percentage change in payments and get expensive patients
expensive_patients<-pivot_wider(change_increase,
                                names_from = dos_year,
                                values_from = sum_payment, 
                                values_fill = list(sum_payment = 0)) %>% 
          mutate(percent_change = (`2018`-`2017`)/`2017` * 100) %>% 
          filter(percent_change > 50 & `2017` != 0) %>% 
          arrange (desc(percent_change))  
          
   
  
       
```

```{r}
summary_wds %>% 
  filter(patient_id =='798094') %>% 
  arrange (dos_year,dos_month)

```


```{r}
year_plot<- summary_wds %>% 
  group_by(dos_year,dos_month) %>% 
  summarise(sum_pay = sum(payment)) %>% 
  ungroup()  

year_plot$dos_month <- as.factor(year_plot$dos_month)
year_plot$dos_year <- as.factor(year_plot$dos_year)

pl <- ggplot( year_plot,aes(y=sum_pay, x = dos_month ,fill=dos_year)) +
  geom_bar(stat = "identity",position = 'dodge') +
  labs(x="Months", y= "Payments") +
  ggtitle("Total payments increase in each month in 2018")
       
pl
year_plot
  
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
```{r}
summary_wds %>% 
  group_by(dos_month,dos_year) %>% 
  summarise(
            total_patients = NROW(patient_id),
            totalpayments = sum(payment),
            min_pay = min(payment),
            max_pay = max(payment),
            avg_pay = sum(payment)/NROW(patient_id)) %>% 
  ungroup() %>% 
  arrange(dos_year,dos_month) %>% 
  



```

